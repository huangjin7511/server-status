name: æœåŠ¡çŠ¶æ€æ£€æµ‹

on:
# å½“ä¿®æ”¹ main åˆ†æ”¯çš„å†…å®¹æ—¶è‡ªåŠ¨æ‰§è¡Œè¯¥æµç¨‹
  push:
    branches:
       - main
#å®šæ—¶å¾ªç¯æ¯2ä¸ªå°æ—¶
  schedule:
   - cron: "0 */2 * * *"
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

#è®¾ç½®ä»“åº“çš„è¯»å†™æƒé™
permissions:
  contents: write
  pull-requests: write
  actions: write
  issues: write
  
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - name: delete-workflow
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          retain_days: 0
          keep_minimum_runs: 0
      - name: install network tools
        run: |
          sudo -E apt-get -y update
          sudo -E apt-get install -y net-tools
          sudo timedatectl set-timezone Asia/Shanghai
          
      - name: check server status
        id: check-server-status
        run: |
          set +e

          create_issue() {
            #æ£€æŸ¥Issueæ˜¯å¦å·²å­˜åœ¨
            issue_title="ğŸ›‘ $1-$2-$3-$4 ç¦»çº¿äº†"
            
            current_date=$(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')
            RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues?state=open)
            ISSUE_EXISTS=$(echo "$RESPONSE" | jq -r --arg TITLE "$issue_title" '.[] | select(.title == $TITLE) | .title')
            if [ -n "$ISSUE_EXISTS" ]; then
              return
            else
              echo "æœªæ‰¾åˆ°ç›¸åŒçš„ Issueï¼Œåˆ›å»ºissueé€šçŸ¥ã€‚"
            fi
            # è°ƒç”¨ GitHub API åˆ›å»º Issue
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues \
              -d "{\"title\": \"${issue_title}\", \"body\": \"### ${current_date} \\n\\n ğŸ›‘ $1  $2  $3  $4  ç¦»çº¿äº†ğŸ˜«\"}"
            echo -e "å·²æˆåŠŸåˆ›å»ºæ–°çš„ Issue: $issue_title  \n\n### ${current_date} \n\n ğŸ›‘ $1  $2  $3  $4  ç¦»çº¿äº†ğŸ˜«"
          }
          close_issue() {
            issue_title="ğŸ›‘ $1-$2-$3-$4 ç¦»çº¿äº†"
            # è·å–æ‰€æœ‰ Open çŠ¶æ€çš„ Issue
            RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues?state=open)

            # æŸ¥æ‰¾ç›¸åŒæ ‡é¢˜çš„ Issue ID
            ISSUE_ID=$(echo "$RESPONSE" | jq -r --arg TITLE "$issue_title" '.[] | select(.title == $TITLE) | .number')
            current_date=$(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')
            if [ -n "$ISSUE_ID" ]; then
                echo "æ‰¾åˆ°${issue_title}çš„ Issue ID: $ISSUE_IDã€‚"
            else
                return
            fi
            # å›å¤æŒ‡å®šå†…å®¹åˆ° Issue
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${ISSUE_ID}/comments \
              -d "{\"body\": \"### ${current_date} \\n\\n ğŸŸ¢ $1  $2  $3  $4 å·²ç»æ¢å¤æ­£å¸¸è¿è¡Œäº†âœ…\"}"
            
            # è°ƒç”¨ GitHub API å…³é—­ Issue
            curl -X PATCH \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${ISSUE_ID} \
              -d "{\"state\": \"closed\"}"
            echo "å·²å…³é—­ ã€${issue_title}ã€‘ Issue ID: $ISSUE_IDã€‚"
          }
          rm README.md && touch README.md
          
          echo "# æœåŠ¡çŠ¶æ€" | tee -a README.md
          echo -e "**è®¿é—®æ•°**ï¼š![hello](https://views.whatilearened.today/views/github/${GITHUB_REPOSITORY}.svg)![](https://pgy.us.kg/?id=svg)![](http://s4.serv00.com:8828/?id=svg)<p><img src="http://ip.cnqq.cloudns.ch/" width="400" onerror=\"this.style.display='none';\"></p>\n" | tee -a README.md >/dev/null 2>&1
          echo "> è¿™ä¸ª[README](https://github.com/${GITHUB_REPOSITORY})æ¯5å°æ—¶ç”±Github actionç”Ÿæˆä¸€æ¬¡." | tee -a README.md
          echo "## ä¸Šæ¬¡æ›´æ–°æ—¶é—´ï¼š" | tee -a README.md
          date "+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S" | tee -a README.md
          echo "## å…¬å…±èŠ‚ç‚¹çŠ¶æ€ï¼š " | tee -a README.md
          echo "å…¬å…±èŠ‚ç‚¹ä»…ç”¨äºæµ‹è¯•ï¼Œå¯¹äºç”Ÿäº§ï¼Œè¯·è®¾ç½®æ‚¨è‡ªå·±çš„èŠ‚ç‚¹." | tee -a README.md
          echo "" | tee -a README.md
          echo "|æœåŠ¡åç§°|åè®®|æœåŠ¡å™¨åœ°å€|ç«¯å£|å¤‡æ³¨ä¿¡æ¯|IPV4/IPV6|**çŠ¶æ€**|å†å²çŠ¶æ€|" |tee -a README.md
          echo "|--|--|--|--|--|--|--|--|" |tee -a README.md
          
          # è¯»å– server.txt æ–‡ä»¶å¹¶éå†æ¯ä¸€è¡Œ
          awk '{print $0}' server.txt | while IFS=' ' read -r name protocol address port region ipv; do
          # æ’é™¤ä»¥ # å¼€å¤´çš„è¡Œå’Œç©ºè¡Œ
          if [[ -z "$name" || "$name" =~ ^# ]]; then
              continue  # å¦‚æœæ˜¯ç©ºè¡Œæˆ–ä»¥ # å¼€å¤´çš„è¡Œï¼Œè·³è¿‡å½“å‰å¾ªç¯
          fi
          # åˆ¤æ–­ $4 æ˜¯å¦æ˜¯ç«¯å£ï¼ˆæ£€æŸ¥æ˜¯å¦ä¸ºçº¯æ•°å­—ä¸”èŒƒå›´åœ¨ 1-65535ï¼‰
          if [[ ! "$port" =~ ^[0-9]+$ || "$port" -lt 1 || "$port" -gt 65535 ]]; then
              ipv="$region"    # å°† $5 çš„å€¼èµ‹ç»™ $6
              region="$port"   # å°† $4 çš„å€¼èµ‹ç»™ $5
              port=""          # å°† $5 æ¸…ç©º
          fi
          # åˆ¤æ–­æ˜¯å¦éœ€è¦å¡«å……åœ°åŒºä¿¡æ¯
          if [[ -z "$ipv" && "$region" =~ ^(V4|v4|IPv4|v4/v6|ipv4|ipv4/ipv6|v6|IPv6|ipv6|v4/v6|ipv4/v6)$ ]]; then
              # å¦‚æœ $6 ä¸ºç©ºä¸” $5 ä¸­åŒ…å« IPV4/IPV6 æ ‡è¯†ï¼Œè®¤ä¸ºå¤‡æ³¨ä¿¡æ¯ä¸ºç©º
              ipv="$region"   # å°† $5 çš„å€¼èµ‹ç»™ $6ï¼Œå³æ ‡è¯† IP ç±»å‹
              region=""       # å°†å¤‡æ³¨ä¿¡æ¯æ¸…ç©º
          fi
          # åˆ¤æ–­åè®®ç±»å‹
          if [[ "$protocol" == "HTTP" || "$protocol" == "http" || "$protocol" == "HTTPS" || "$protocol" == "https" ]]; then
              # æµ‹è¯• HTTP/HTTPS è¿æ¥æ˜¯å¦æ­£å¸¸
              if [[ "$port" != "" ]]; then
                  # å¦‚æœæœ‰ç«¯å£å·ï¼Œåˆ™æ·»åŠ ç«¯å£
                  response_code=$(curl -Lks -w "%{http_code}" -o /dev/null "$protocol://$address:$port")
                  name="[$name](${protocol}://${address}:${port})"
              else
                  # æ²¡æœ‰ç«¯å£å·ï¼Œç›´æ¥ä½¿ç”¨é»˜è®¤ç«¯å£
                  response_code=$(curl -Lks -w "%{http_code}" -o /dev/null "$protocol://$address")
                  name="[$name](${protocol}://${address})"
              fi
        
              if [[ "$response_code" -eq 200 ]]; then
                  status="æ­£å¸¸âœ…"
              else
                  status="ç¦»çº¿âŒ"
              fi
          elif [[ "$protocol" == "TCP" || "$protocol" == "tcp" || "$protocol" == "ws" || "$protocol" == "WS" || "$protocol" == "WSS" || "$protocol" == "wss" ]]; then
              # TCPåè®®
              nc -v -w 3 -z "$address" "$port" &>/dev/null
              if [[ $? -eq 0 ]]; then
                  status="æ­£å¸¸âœ…"
              else
                  status="ç¦»çº¿âŒ"
              fi
          else
              status="æœªçŸ¥âš ï¸"
          fi

          # æ›´æ–°å†å²è®°å½•æ–‡ä»¶
          [ ! -d "history" ] && mkdir -p history
          history_file="history/${protocol}-${address}-${port}.txt"
          [ ! -f "$history_file" ] && touch "$history_file"
          echo "$(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')ï¼š $status" >> "$history_file"
          tail -n 10 "$history_file" > "$history_file.temp" && mv "$history_file.temp" "$history_file"

          # ç”Ÿæˆå†å²çŠ¶æ€æ˜¾ç¤º
          history_status=$(tail -n 10 "$history_file" | awk '{if($3=="æ­£å¸¸âœ…") printf "ğŸŸ©"; else if($3=="æœªçŸ¥âš ï¸") printf "ğŸŸ¨"; else printf "ğŸŸ¥"}')
          green_count=$(echo "$history_status" | grep -o "ğŸŸ©" | wc -l)
          #total_count=$(echo "$history_status" | wc -m)
          #total_count=$((total_count - 1)) # å»é™¤æ¢è¡Œç¬¦
          total_count=$(echo "$history_status" | wc -c)
          #emojiè¡¨æƒ…å 4ä¸ªå­—èŠ‚
          total_count=$((total_count / 4))
          percentage=$((green_count * 100 / total_count))
          
          if [[ "$status" = "æ­£å¸¸âœ…" || "$status" = "æœªçŸ¥âš ï¸" ]] ; then
            echo "|$name|$protocol|$address|$port|$region|$ipv|$status|[${history_status}]($history_file) $percentage%|" |tee -a README.md >/dev/null 2>&1
            #å…³é—­issue
            close_issue "${name}" "${protocol}" "${address}" "${port}"
          else 
            echo "|$name|<span style="color:red">$protocol</span>|<span style="color:red">$address</span>|<span style="color:red">$port</span>|<span style="color:red">$region</span>|<span style="color:red">$ipv</span>|<span style="color:red">ç¦»çº¿</span>âŒ|[${history_status}]($history_file) <span style="color:red">$percentage%</span>|" | tee -a README.md >/dev/null 2>&1
            #åˆ›å»ºissueé€šçŸ¥
            create_issue "${name}" "${protocol}" "${address}" "${port}"
          fi
          done
      - name: Commit files
        run: |
          git config --local user.email "github-actions@github.com"
          git config --local user.name "github-actions"
          git add .
          git commit -m "æ›´æ–°æœåŠ¡çŠ¶æ€ ï¼š $(date '+%Y-%m-%d %H:%M:%S')" -a
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          force_with_lease: true
      - name: è‡ªç”¨æ›´æ–°
        if: github.repository_owner == 'lmq8267' # åˆ¤æ–­ä»“åº“æ‰€æœ‰è€…æ˜¯å¦æ˜¯ lmq8267 æ‰æ‰§è¡Œ
        env:
          #è¯»å–ç¯å¢ƒå˜é‡
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          USER: ${{ secrets.SERVER }}
          CMD: ${{ secrets.CMD }}
        run: |
          #è¿œç¨‹sshæ‰§è¡Œæ›´æ–°å‘½ä»¤
          sudo apt-get install -y sshpass
          sshpass -p "${{ secrets.SSH_PRIVATE_KEY }}" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "${{ secrets.SERVER }}" "${{ secrets.CMD }}"

  keepalive-workflow:
    name: keepalive
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: gautamkrishnar/keepalive-workflow@v2
        #with:
          #use_api: true
